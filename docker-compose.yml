version: "3.8"
services:
  cpp:
    build:
      context: .
      target: cpp-runtime
    image: hello-ubuntu-cpp:latest
    container_name: hello_cpp
    stdin_open: true
    tty: true
    command: ["/bin/bash"]

  spring:
    # Use a prebuilt image to avoid docker-compose 'ContainerConfig' errors
    # Build the image separately with `docker build --target spring-runtime -t spring-hello-world:latest .`
    image: spring-hello-world:latest
    container_name: spring_app
    ports:
      - "8080:8080"
    volumes:
      - ./spring_hello_world/data:/app/data
    restart: unless-stopped
    environment:
      - JAVA_OPTS=-Xms128m -Xmx512m
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  help:
    build:
      context: .
      target: django-runtime
    image: hello-help-site:latest
    container_name: help_site
    ports:
      - "8001:8001"
    volumes:
      - ./django_help:/app
    environment:
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
