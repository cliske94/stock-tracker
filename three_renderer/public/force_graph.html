<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Force Graph — Repo Visualizer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <style>body{margin:0;font-family:Arial,Helvetica,sans-serif}svg{width:100vw;height:100vh;display:block}#top{position:absolute;left:8px;top:8px;z-index:20;background:#fff;padding:8px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.12)}</style>
</head>
<body>
  <div id="top"><a href="viewer_gltf.html">Back to Viewer</a> — <b>Force Graph</b></div>
  <svg id="svg"></svg>
  <script>
    async function load(){
      const r = await fetch('model_meta.json');
      const meta = await r.json();
      const nodes = (meta.nodes||[]).map(n=>({id:n.id, name:n.name||n.id, type:n.type||'node'}));
      const links = (meta.edges||[]).map(e=>({source:e.from, target:e.to, label:e.label||''}));

      const width = innerWidth, height = innerHeight;
      const svg = d3.select('#svg').attr('viewBox', [0,0,width,height]);
      const color = d3.scaleOrdinal(d3.schemeCategory10);

      const sim = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(links).id(d=>d.id).distance(80).strength(0.7))
        .force('charge', d3.forceManyBody().strength(-220))
        .force('center', d3.forceCenter(width/2, height/2));

      const link = svg.append('g').attr('stroke','#999').attr('stroke-opacity',0.7)
        .selectAll('line').data(links).enter().append('line').attr('stroke-width',1.5);

      const node = svg.append('g').selectAll('g').data(nodes).enter().append('g').call(drag(sim));
      node.append('circle').attr('r',10).attr('fill', d=>color(d.type));
      node.append('text').text(d=>d.name).attr('x',14).attr('y',4).style('font-size','12px');

      sim.on('tick', ()=>{
        link.attr('x1', d=>d.source.x).attr('y1', d=>d.source.y).attr('x2', d=>d.target.x).attr('y2', d=>d.target.y);
        node.attr('transform', d=>`translate(${d.x},${d.y})`);
      });

      node.on('click', (event,d)=>{
        navigator.clipboard && navigator.clipboard.writeText(d.id).then(()=>{
          console.log('copied',d.id);
        }).catch(()=>{});
      });

      function drag(sim){
        function started(event,d){ if(!event.active) sim.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
        function dragged(event,d){ d.fx = event.x; d.fy = event.y; }
        function ended(event,d){ if(!event.active) sim.alphaTarget(0); d.fx = null; d.fy = null; }
        return d3.drag().on('start',started).on('drag',dragged).on('end',ended);
      }
    }
    load().catch(e=>{ document.body.innerHTML = 'Load failed: '+e; console.error(e); });
  </script>
</body>
</html>
