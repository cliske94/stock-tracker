<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Matrix Heatmap — Repo Coupling</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>body{margin:0;font-family:Arial,Helvetica,sans-serif}canvas{width:100vw;height:100vh;display:block}#top{position:absolute;left:8px;top:8px;z-index:20;background:#fff;padding:8px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.12)}</style>
</head>
<body>
  <div id="top" style="position:fixed;left:8px;top:8px;z-index:20;background:#fff;padding:8px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.12)">
    <a href="viewer_gltf.html">3D Viewer</a> ·
    <a href="force_graph.html">Force Graph</a> ·
    <a href="treemap.html">Treemap</a> ·
    <a href="matrix_heatmap.html"><b>Matrix</b></a>
  </div>
  <canvas id="c"></canvas>
  <div id="tooltip" style="position:fixed;pointer-events:none;display:none;z-index:50;background:rgba(255,255,255,0.95);border:1px solid #ccc;padding:8px;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,.12);font-size:13px;max-width:320px"></div>
  <script>
    async function load(){
      const meta = await fetch('model_meta.json').then(r=>r.json());
      const nodes = (meta.nodes||[]).map(n=>n.id);
      const index = new Map(nodes.map((id,i)=>[id,i]));
      const N = nodes.length;
      const mat = Array.from({length:N}, ()=>new Uint16Array(N));
      const edgeMap = new Map();
      for(const e of (meta.edges||[])){
        const i = index.get(e.from), j = index.get(e.to);
        if(i!=null && j!=null){
          mat[i][j] = (mat[i][j]||0) + 1;
          const key = i + ',' + j;
          if (!edgeMap.has(key)) edgeMap.set(key, []);
          edgeMap.get(key).push(e);
        }
      }

      const canvas = document.getElementById('c');
      canvas.width = Math.max(600, Math.min(2000, N*16));
      canvas.height = canvas.width;
      const ctx = canvas.getContext('2d');
      const cell = Math.floor(canvas.width / N) || 1;
      // draw cells
      for(let i=0;i<N;i++){
        for(let j=0;j<N;j++){
          const v = mat[i][j];
          const norm = Math.min(1, v/5);
          const r = Math.floor(255*norm), g = 40, b = Math.floor(255*(1-norm));
          ctx.fillStyle = `rgb(${r},${g},${b})`;
          ctx.fillRect(j*cell, i*cell, cell, cell);
        }
      }
      // labels on left
      ctx.fillStyle='black'; ctx.font='12px sans-serif'; ctx.textBaseline='middle';
      for(let i=0;i<N;i++){ ctx.fillText(nodes[i], 4, i*cell + cell/2); }

      // tooltip handling
      const tooltip = document.getElementById('tooltip');
      canvas.style.cursor = 'crosshair';
      canvas.addEventListener('mousemove', (ev)=>{
        const rect = canvas.getBoundingClientRect();
        const x = ev.clientX - rect.left, y = ev.clientY - rect.top;
        const j = Math.floor(x / cell), i = Math.floor(y / cell);
        if (i >= 0 && i < N && j >= 0 && j < N){
          const key = i + ',' + j;
          const edges = edgeMap.get(key) || [];
          const count = mat[i][j] || edges.length || 0;
          let html = `<b>${nodes[i]}</b> → <b>${nodes[j]}</b><br/>Count: ${count}`;
          if (edges.length){
            html += '<hr style="margin:6px 0;">';
            const list = edges.slice(0,5).map(e=>{
              const lbl = e.label ? e.label : (e.type ? e.type : 'edge');
              return `<div style="margin-bottom:4px">${lbl} <span style="color:#666;font-size:12px">(${e.from}→${e.to})</span></div>`;
            }).join('');
            html += list;
            if (edges.length > 5) html += `<div style="color:#666;font-size:12px">(+${edges.length-5} more)</div>`;
          }
          tooltip.innerHTML = html;
          tooltip.style.display = 'block';
          // position near cursor but keep on-screen
          const left = Math.min(window.innerWidth - 12 - tooltip.offsetWidth, ev.clientX + 12);
          const top = Math.min(window.innerHeight - 12 - tooltip.offsetHeight, ev.clientY + 12);
          tooltip.style.left = left + 'px';
          tooltip.style.top = top + 'px';
        } else {
          tooltip.style.display = 'none';
        }
      });
      canvas.addEventListener('mouseleave', ()=>{ tooltip.style.display = 'none'; });
    }
    load().catch(e=>{ document.body.innerHTML = 'Load failed: '+e; console.error(e); });
  </script>
</body>
</html>
