<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Treemap — Repo Metrics</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <style>body{margin:0;font-family:Arial,Helvetica,sans-serif}svg{width:100vw;height:100vh;display:block}#top{position:absolute;left:8px;top:8px;z-index:20;background:#fff;padding:8px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.12)}</style>
</head>
<body>
  <div id="top"><a href="viewer_gltf.html">Back to Viewer</a> — <b>Treemap (LOC)</b></div>
  <svg id="svg"></svg>
  <script>
    async function load(){
      const m = await fetch('model_meta_metrics.json').then(r=>r.ok? r.json() : null);
      const meta = await fetch('model_meta.json').then(r=>r.json());
      const nodes = (meta.nodes||[]).map(n=>({id:n.id,name:n.name||n.id, repo:n.repo||n.id}));
      const metrics = (m && m.nodes) ? m.nodes.reduce((acc,x)=>{acc[x.id]=x;return acc},{}) : {};

      // Build simple hierarchy by repo path prefix
      const children = nodes.map(n=>{
        const parts = (n.repo||'').split('/').filter(Boolean);
        const group = parts.length? parts[0] : 'root';
        const loc = (metrics[n.id] && metrics[n.id].loc) || 1;
        return { group, name:n.name, id:n.id, value: loc };
      });

      const root = d3.rollup(children, v=>Array.from(v), d=>d.group);
      const data = { name:'root', children: Array.from(root, ([k,v])=>({ name:k, children:v })) };

      const width = innerWidth, height = innerHeight;
      const svg = d3.select('#svg').attr('viewBox',[0,0,width,height]);
      const treemap = d3.treemap().size([width, height]).padding(2);
      const rootNode = d3.hierarchy(data).sum(d=>d.value||0).sort((a,b)=>b.value-a.value);
      treemap(rootNode);

      const color = d3.scaleOrdinal(d3.schemeTableau10);
      const g = svg.selectAll('g').data(rootNode.leaves()).enter().append('g').attr('transform', d=>`translate(${d.x0},${d.y0})`);
      g.append('rect').attr('width', d=>d.x1-d.x0).attr('height', d=>d.y1-d.y0).attr('fill', d=>color(d.parent.data.name));
      g.append('text').attr('x',6).attr('y',14).text(d=>d.data.name).style('font-size','12px').style('pointer-events','none');
    }
    load().catch(e=>{ document.body.innerHTML = 'Load failed: '+e; console.error(e); });
  </script>
</body>
</html>
