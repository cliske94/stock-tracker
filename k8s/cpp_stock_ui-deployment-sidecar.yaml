apiVersion: apps/v1
kind: Deployment
metadata:
  name: cpp-stock-ui-sidecar
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cpp-stock-ui-sidecar
  template:
    metadata:
      labels:
        app: cpp-stock-ui-sidecar
    spec:
      containers:
        - name: app
          image: cliske01/cpp-stock-ui:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 9090
              name: health
          env:
            - name: VNC_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: cpp-stock-ui-secret
                  key: VNC_PASSWORD
            - name: BACKEND_URL
              value: "http://spring_app:8080"
            - name: BACKEND_HEARTBEAT_URL
              value: "http://spring_app:8080/heartbeat"
            - name: DASHBOARD_URL
              value: "http://dashboard:8085"
          readinessProbe:
            httpGet:
              path: /internal/heartbeat
              port: 9090
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
          volumeMounts:
            - name: app-logs
              mountPath: /var/log
        - name: log-sidecar
          image: local/log-sidecar:latest
          imagePullPolicy: IfNotPresent
          env:
            - name: APP_NAME
              value: "cpp-stock-ui"
            - name: LOG_PATH
              value: "/var/log/app.log"
            - name: COLLECTOR_URL
              value: "http://log-collector.default.svc.cluster.local:5000/ingest"
            - name: REPORT_INTERVAL
              value: "60"
          volumeMounts:
            - name: app-logs
              mountPath: /var/log
      volumes:
        - name: app-logs
          emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: cpp-stock-ui-sidecar
spec:
  selector:
    app: cpp-stock-ui-sidecar
  ports:
    - name: health
      port: 9090
      targetPort: 9090
  type: ClusterIP
