apiVersion: apps/v1
kind: Deployment
metadata:
  name: cpp-stock-ui
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cpp-stock-ui
  template:
    metadata:
      labels:
        app: cpp-stock-ui
    spec:
      containers:
        - name: cpp-stock-ui
          image: cliske01/cpp-stock-ui:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 6082
              name: novnc
            - containerPort: 5901
              name: vnc
            - containerPort: 9090
              name: health
          env:
            - name: VNC_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: cpp-stock-ui-secret
                  key: VNC_PASSWORD
            - name: BACKEND_URL
              value: "http://spring_app:8080"
            - name: BACKEND_HEARTBEAT_URL
              value: "http://spring_app:8080/heartbeat"
            - name: ENABLE_CRUD_CHECK
              value: "true"
            - name: BACKEND_TOKEN
              valueFrom:
                secretKeyRef:
                  name: backend-credentials
                  key: BACKEND_TOKEN
            - name: DASHBOARD_URL
              value: "http://dashboard:8085"
          readinessProbe:
            httpGet:
              path: /internal/healthcheck
              port: 9090
            initialDelaySeconds: 20
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /internal/heartbeat
              port: 9090
            initialDelaySeconds: 30
            periodSeconds: 20
            timeoutSeconds: 5
            failureThreshold: 3
        - name: metrics-sidecar
          image: curlimages/curl:8.2.1
          imagePullPolicy: IfNotPresent
          env:
            - name: DASHBOARD_URL
              value: "http://dashboard:8085"
            - name: METRIC_SERVICE
              value: "cpp_stock_ui"
            - name: METRIC_INTERVAL
              value: "60"
          command:
            - /bin/sh
            - -c
            - |
              DASH=${DASHBOARD_URL:-http://dashboard:8085}
              SERVICE=${METRIC_SERVICE:-cpp_stock_ui}
              INTERVAL=${METRIC_INTERVAL:-60}
              while true; do
                curl -sS -X POST "$DASH/ingest" -H 'Content-Type: application/json' \
                  -d "{\"service\":\"$SERVICE\",\"uptime\":$(date +%s),\"requests\":0}" >/dev/null 2>&1 || true
                sleep "$INTERVAL"
              done
        - name: prom-exporter
          image: python:3.11-slim
          imagePullPolicy: IfNotPresent
          env:
            - name: EXPORTER_SERVICE
              value: "cpp_stock_ui"
            - name: DASHBOARD_URL
              value: "http://dashboard:8085"
            - name: EXPORTER_PORT
              value: "9110"
          ports:
            - containerPort: 9110
              name: exporter
          command:
            - /bin/sh
            - -c
          args:
            - |
              cat > /tmp/exporter.py <<'PY'
              import time, threading, json, os, urllib.request
              from http.server import HTTPServer, BaseHTTPRequestHandler
              SERVICE=os.environ.get('EXPORTER_SERVICE','cpp_stock_ui')
              DASH=os.environ.get('DASHBOARD_URL','http://dashboard:8085')
              PORT=int(os.environ.get('EXPORTER_PORT','9110'))

              metrics_text = ''

              def build_metrics():
                global metrics_text
                try:
                  with urllib.request.urlopen(DASH + '/api/latest', timeout=2) as r:
                    js = json.loads(r.read().decode())
                except Exception:
                  js = {}
                val = js.get(SERVICE, {})
                now = int(time.time())
                up = 0
                if val and 'ts' in val and now - int(val.get('ts',0)) <= int(os.environ.get('UP_THRESHOLD','90')):
                  up = 1
                lines = []
                lines.append('# HELP exporter_up gauge')
                lines.append('# TYPE exporter_up gauge')
                lines.append(f'exporter_up{{service="{SERVICE}"}} {up}')
                if val:
                  lines.append(f'exporter_uptime_seconds{{service="{SERVICE}"}} {int(val.get("uptime",0))}')
                  lines.append(f'exporter_requests_total{{service="{SERVICE}"}} {int(val.get("requests",0))}')
                metrics_text = '\n'.join(lines) + '\n'

              def poll_loop():
                while True:
                  try:
                    build_metrics()
                  except Exception:
                    pass
                  time.sleep(5)

              class H(BaseHTTPRequestHandler):
                def do_GET(self):
                  if self.path != '/metrics':
                    self.send_response(404); self.end_headers(); return
                  self.send_response(200)
                  self.send_header('Content-Type','text/plain; version=0.0.4; charset=utf-8')
                  self.end_headers()
                  self.wfile.write(metrics_text.encode())

              t = threading.Thread(target=poll_loop, daemon=True)
              t.start()
              server = HTTPServer(('0.0.0.0', PORT), H)
              server.serve_forever()
              PY
              python3 /tmp/exporter.py
---
apiVersion: v1
kind: Service
metadata:
  name: cpp-stock-ui
spec:
  selector:
    app: cpp-stock-ui
  ports:
    - name: http
      port: 6082
      targetPort: 6082
  type: ClusterIP
                cat > /tmp/exporter.py <<'PY'
                import time, threading, json, os, urllib.request
                from http.server import HTTPServer, BaseHTTPRequestHandler
                SERVICE=os.environ.get('EXPORTER_SERVICE','cpp_stock_ui')
                DASH=os.environ.get('DASHBOARD_URL','http://dashboard:8085')
                PORT=int(os.environ.get('EXPORTER_PORT','9110'))

                metrics_text = ''

                def build_metrics():
                  global metrics_text
                  try:
                    with urllib.request.urlopen(DASH + '/api/latest', timeout=2) as r:
                      js = json.loads(r.read().decode())
                  except Exception:
                    js = {}
                  val = js.get(SERVICE, {})
                  now = int(time.time())
                  up = 0
                  if val and 'ts' in val and now - int(val.get('ts',0)) <= int(os.environ.get('UP_THRESHOLD','90')):
                    up = 1
                  lines = []
                  lines.append('# HELP exporter_up gauge')
                  lines.append('# TYPE exporter_up gauge')
                  lines.append(f'exporter_up{{service="{SERVICE}"}} {up}')
                  if val:
                    lines.append(f'exporter_uptime_seconds{{service="{SERVICE}"}} {int(val.get("uptime",0))}')
                    lines.append(f'exporter_requests_total{{service="{SERVICE}"}} {int(val.get("requests",0))}')
                  metrics_text = '\n'.join(lines) + '\n'

                def poll_loop():
                  while True:
                    try:
                      build_metrics()
                    except Exception:
                      pass
                    time.sleep(5)

                class H(BaseHTTPRequestHandler):
                  def do_GET(self):
                    if self.path != '/metrics':
                      self.send_response(404); self.end_headers(); return
                    self.send_response(200)
                    self.send_header('Content-Type','text/plain; version=0.0.4; charset=utf-8')
                    self.end_headers()
                    self.wfile.write(metrics_text.encode())

                t = threading.Thread(target=poll_loop, daemon=True)
                t.start()
                server = HTTPServer(('0.0.0.0', PORT), H)
                server.serve_forever()
                PY
                python3 /tmp/exporter.py
---
apiVersion: v1
kind: Service
metadata:
  name: cpp-stock-ui
spec:
  selector:
    app: cpp-stock-ui
  ports:
    - name: http
      port: 6082
      targetPort: 6082
  type: ClusterIP
